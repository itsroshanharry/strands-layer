name: Build Lambda Layer

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'requirements.txt'

jobs:
  build-lambda-layer:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build layer in Lambda-compatible environment
        run: |
          # Create a Dockerfile that uses the EXACT Lambda Python 3.11 environment
          cat > Dockerfile <<'EOF'
          FROM public.ecr.aws/lambda/python:3.11
          
          COPY requirements.txt .
          
          RUN mkdir -p /asset/python && \
              pip install --upgrade pip && \
              pip install -r requirements.txt -t /asset/python/ --no-cache-dir
          
          # Cleanup unnecessary files
          RUN cd /asset/python && \
              find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
              find . -type f -name "*.pyc" -delete && \
              find . -type f -name "*.pyo" -delete && \
              find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
              find . -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          
          WORKDIR /asset
          EOF
          
          # Build the Docker image
          docker build -t lambda-layer-builder .
          
          # Create a container and copy the built layer out
          docker create --name temp-container lambda-layer-builder
          docker cp temp-container:/asset ./layer
          docker rm temp-container
      
      - name: Verify layer contents
        run: |
          echo "ğŸ“¦ Layer contents:"
          ls -lh layer/python/ | head -30
          echo ""
          echo "ğŸ“Š Layer size before zipping:"
          du -sh layer/python/
          echo ""
          echo "âœ… Layer built in AWS Lambda Python 3.11 container - guaranteed compatible!"
      
      - name: Create ZIP file
        run: |
          cd layer
          zip -r ../strands-lambda-layer.zip python/
          cd ..
          echo "ğŸ“ Layer size:"
          ls -lh strands-lambda-layer.zip
          du -h strands-lambda-layer.zip
      
      - name: Upload layer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: strands-lambda-layer
          path: strands-lambda-layer.zip
          retention-days: 7
      
      - name: Display success message
        run: |
          echo "âœ… Lambda layer built successfully in AWS Lambda Python 3.11 environment!"
          echo "ğŸ“¦ Download the artifact from the Actions tab"
          echo "ğŸ¯ This layer is guaranteed to work in Lambda - built in the exact same container!"