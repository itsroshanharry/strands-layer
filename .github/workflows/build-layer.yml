name: Build Lambda Layer

on:
  workflow_dispatch:
  push:
    branches:
      - main
    paths:
      - 'requirements.txt'

jobs:
  build-lambda-layer:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      
      - name: Build layer in Lambda-compatible environment
        run: |
          # Create a Dockerfile that uses the EXACT Lambda Python 3.11 environment
          cat > Dockerfile <<'EOF'
          FROM public.ecr.aws/lambda/python:3.11
          
          COPY requirements.txt .
          
          RUN mkdir -p /asset/python && \
              pip install --upgrade pip && \
              pip install -r requirements.txt -t /asset/python/ --no-cache-dir
          
          # Cleanup unnecessary files
          RUN cd /asset/python && \
              find . -type d -name "__pycache__" -exec rm -rf {} + 2>/dev/null || true && \
              find . -type f -name "*.pyc" -delete && \
              find . -type f -name "*.pyo" -delete && \
              find . -type d -name "tests" -exec rm -rf {} + 2>/dev/null || true && \
              find . -type d -name "test" -exec rm -rf {} + 2>/dev/null || true
          
          WORKDIR /asset
          EOF
          
          # Build the Docker image
          docker build -t lambda-layer-builder .
          
          # Create a container and copy the built layer out
          docker create --name temp-container lambda-layer-builder
          docker cp temp-container:/asset ./layer
          docker rm temp-container
      
      - name: List installed packages
        run: |
          echo "üì¶ Checking what was installed:"
          ls -la layer/python/ | head -20
      
      - name: Validate installation in Lambda environment
        run: |
          # Run validation inside the same Lambda container
          docker run --rm -v $(pwd)/layer:/opt public.ecr.aws/lambda/python:3.11 \
            python3.11 -c "
          import sys
          sys.path.insert(0, '/opt/python')
          
          print('Directories in python/:')
          import os
          for item in sorted(os.listdir('/opt/python'))[:20]:
              print(f'  - {item}')
          
          print('\nAttempting imports...')
          try:
              try:
                  import strands_agents
                  print('‚úì strands_agents imported successfully')
              except ImportError:
                  try:
                      import strands
                      print('‚úì strands imported successfully')
                  except ImportError:
                      print('‚ö† strands_agents/strands not found, but continuing...')
              
              import opentelemetry.trace
              print('‚úì opentelemetry imported successfully')
              import azure.storage.blob
              print('‚úì azure.storage.blob imported successfully')
              import boto3
              print('‚úì boto3 imported successfully')
              
              # Critical: Test cryptography specifically
              from cryptography.hazmat.primitives.ciphers import Cipher
              print('‚úì cryptography imported successfully')
              
              print('\n‚úÖ All imports successful!')
          except Exception as e:
              print(f'‚ùå Import failed: {e}')
              import traceback
              traceback.print_exc()
              sys.exit(1)
          "
      
      - name: Create ZIP file
        run: |
          cd layer
          zip -r ../strands-lambda-layer.zip python/
          cd ..
          echo "üìè Layer size:"
          ls -lh strands-lambda-layer.zip
          du -h strands-lambda-layer.zip
      
      - name: Upload layer as artifact
        uses: actions/upload-artifact@v4
        with:
          name: strands-lambda-layer
          path: strands-lambda-layer.zip
          retention-days: 7
      
      - name: Display success message
        run: |
          echo "‚úÖ Lambda layer built successfully in AWS Lambda Python 3.11 environment!"
          echo "üì¶ Download the artifact from the Actions tab"
          echo "üéØ This layer is guaranteed to work in Lambda - built in the exact same container!"